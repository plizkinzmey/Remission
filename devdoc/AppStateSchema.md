# AppStateSchema

Документ описывает структуру и правила эволюции корневого состояния приложения Remission,
которым управляет `AppReducer`. Он служит контрактом между UI, фичами и потенциальным
персистентным хранилищем (например, iCloud/CoreData).

## Версии

| Версия | Секции | Назначение |
| --- | --- | --- |
| `legacy` | — | Состояние, созданное до появления версионирования. Используется только для миграции. |
| `v1` | `serverList`, `path` | Базовый набор навигации: список серверов и стек деталей. |

`AppStateVersion.latest` указывает на текущую рабочую версию и применяется во всех новых
инициализациях (`AppBootstrap.makeInitialState`).

## Секции состояния (`v1`)

### `serverList: ServerListReducer.State`
Хранит набор сохранённых `ServerConfig`, фильтры, прогресс загрузки и делегаты. Любые новые
флаги должны добавляться в `ServerListReducer.State` с учётом тестового покрытия TCA.

### `path: StackState<ServerDetailReducer.State>`
Отражает текущую иерархию экранов деталей сервера. Значение формируется исключительно через
действия TCA (`ServerListReducer.Action.delegate(.serverSelected)` → push, действия деталей
→ pop). При несовпадении версий или невозможности восстановить навигацию стек очищается.

## Навигация и очистка стека

- `AppBootstrap.makeInitialState` выполняет миграцию перед применением UI фикстур.
- При изменении версии (`existingState.version != targetVersion`) стек `path` сбрасывается,
  чтобы исключить ссылки на состояние устаревших редьюсеров.
- Новые разделы (например, onboarding flow) должны объявляться как отдельные ветки состояния
  и документироваться здесь до добавления в код.

## Процедура миграции

1. Добавить кейс в `AppStateVersion` и отметить новую версию как `latest`.
2. Задокументировать изменения в этой таблице и в соответствующем разделе `devdoc/plan.md`.
3. Обновить `AppBootstrap.migrate(_:to:)`, прописав преобразование существующих полей.
   - Если предыдущие данные несовместимы, очистить или пересобрать соответствующую секцию.
   - Стек навигации должен сбрасываться на каждом повышении версии.
4. Расширить тесты (`AppBootstrapTests`, `AppFeatureTests`) сценариями для старых версий.
5. При появлении персистентного хранилища выполнять миграцию перед записью и отображением.

## Будущие расширения

- `session`: агрегированное состояние Transmission (RTC-57+), появится в версии `v2`.
- `onboarding`: wizard для первого запуска.
- Любая новая секция должна описывать:
  - источники данных и зависимости;
  - правила сброса при миграции;
  - взаимодействие с `StackState`/`NavigationStack`.

Все изменения в пользовательских сценариях синхронизируются с `devdoc/PRD.md`, а контракт
состояния—в этом файле и в разделе RTC-58 плана.
