# Гайд по логам и диагностике Remission

## Что логируется и какие уровни
- Источник: `AppLogger` (swift-log) + `TransmissionLogger` для RPC. Уровни: `debug`, `info`, `warning`, `error`.
- Логируется: попытки подключения, ответы/коды Transmission (маскированы), сетевые ошибки, команды (start/stop/add/remove), fallback/retry.
- Не логируется: пароли, Base64 Authorization, session-id, полные URL с credentials, содержимое сертификатов. Заголовки маскируются, тела ответов усекатся до короткой сводки.
- Телеметрия **не зависит** от логов и выключена по умолчанию (см. ниже).

## Как использовать AppLogger в коде
- Инъекция через `@Dependency(\.appLogger)` в редьюсерах/сервисах. В тестах/превью используется `AppLogger.noop`.
- Для выделения категории создавайте дочерний логгер: `let logger = appLogger.withCategory("server-detail")`.
- Пример (TCA reducer effect):
  ```swift
  @Dependency(\.appLogger) var logger

  return .run { send in
      logger.info("Refreshing torrents")
      do {
          let torrents = try await repository.fetch()
          logger.debug("Fetched \(torrents.count) items")
          await send(.response(.success(torrents)))
      } catch {
          logger.error("Fetch failed", metadata: ["reason": "\(error)"])
          await send(.response(.failure(error)))
      }
  }
  ```
- Пример (Transmission logger): при создании `TransmissionClientConfig` передайте `enableLogging: true` и `logger: DefaultTransmissionLogger(appLogger: appLogger)`, чтобы RPC логи писались в тот же sink с маскировкой.
- Все логгеры берут sink только из `DependencyValues.appLogger` (swift-log); прямые `print`/`os.Logger` запрещены даже в временном коде и тестах.

## Включение расширенного логирования
- Базовое логирование (info/error) включено всегда.
- Расширенное (debug + подробные RPC события) управляется флагом `enableLogging` в `ServerConfig.NetworkOptions` и предназначено для диагностики по запросу.
- В пользовательских сборках флаг выключен. Для сбора трассировок:
  1) Поддержка/QA включает `enableLogging` для нужного сервера в диагностической/ debug сборке или конфигурации.
  2) Перезапустить приложение, воспроизвести проблему, после чего выключить флаг.
- Включайте расширенный режим только временно: он увеличивает объём файлов, но продолжает маскировать секреты.

## Где искать логи
- **macOS:** `~/Library/Application Support/Remission/Logs/` (ротация 5 файлов по 10 MB). Для репорта заверните каталог в zip.
- **iOS:** каталог `Library/Application Support/Remission/Logs/` внутри контейнера приложения. Способы выгрузки:
  - Finder → подключённое устройство → Files → Remission → Logs (если файловый шаринг включён в сборке).
  - Xcode → Devices and Simulators → выбрать устройство → Download Container → извлечь `Application Support/Remission/Logs`.
  - В диагностической сборке — использовать кнопку экспорта логов (если доступна).

## Как безопасно готовить отчёт
1. Убедиться, что чувствительные данные отсутствуют (пароли, session-id не пишутся, но всё равно проверить).
2. Передать zip каталога `Logs` и краткое описание шагов воспроизведения.
3. Не отправлять Keychain/пароли; при сомнении удалить строки вручную или спросить поддержку.

## Очистка логов
- macOS: удалить содержимое `~/Library/Application Support/Remission/Logs/` (создастся заново).
- iOS: удалить каталог `Logs` в контейнере (через Finder/Xcode) или переустановить приложение. Ротация ограничивает размер автоматически.

## Телеметрия
- Переключатель: Настройки → «Отправлять анонимную телеметрию».
- Состояние по умолчанию: выключено; отправки выполняются только при явном включении.
- При сборе логов для поддержки телеметрию оставляем выключенной, если не требуется иное согласие.

## Краткий чек-лист для QA/поддержки
- Включить расширенное логирование (диагностическая сборка/флаг `enableLogging`) только на время воспроизведения.
- Зафиксировать шаги и время проблемы.
- Собрать логи (macOS путь или выгрузка контейнера iOS).
- Проверить отсутствие секретов, упаковать в zip, приложить к тикету.
- Выключить расширенное логирование, при необходимости очистить `Logs`.
