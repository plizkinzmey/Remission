# Анализ дублирования кода и возможности рефакторинга (Часть 10)

Анализ проведен: Пятница, 23 января 2026 г.

Десятый этап анализа посвящен «микро-дубликатам» в логике отображения действий торрентов, консолидации форматтеров и наведению порядка в моковых данных для превью.

## 1. Дублирование логики кнопок действий (play/pause/delete)
**Локации:**
- `Remission/Views/TorrentList/Cells/TorrentRowView.swift` (метод `pillIconButton`)
- `Remission/Views/TorrentDetail/TorrentActionsView.swift` (метод `iconButton`)

**Проблема:**
Обе вьюхи независимо определяют:
- Набор иконок (`play.fill`, `pause.fill`, `trash.fill`).
- Цветовую схему (тинты `.orange`, `.green`, `.red`).
- Логику отображения индикатора загрузки (`ProgressView`) поверх кнопки во время выполнения команды.
Это создает риск рассинхрона визуального стиля и поведения кнопок в списке и деталях.

**Возможность рефакторинга:**
Создать универсальный компонент `AppTorrentActionButton` и перечисление `TorrentActionType` в папке `Shared`. Это позволит централизовать описание действий (иконка + цвет + текст) и логику состояния «занят».

## 2. Разделение ответственности в форматтерах
**Локации:**
- `Remission/Shared/Formatters/TorrentDataFormatter.swift`
- `Remission/Views/TorrentDetail/TorrentDetailFormatters.swift`

**Проблема:**
`TorrentDetailFormatters` содержит полезную логику (текстовые статусы торрентов, цвета приоритетов), которая жестко привязана к экрану деталей. При этом она частично дублирует или просто оборачивает методы из `TorrentDataFormatter`.

**Возможность рефакторинга:**
Перенести всю «бизнес-логику» форматирования торрентов (статусы, приоритеты, цвета) в `TorrentDataFormatter` или создать `TorrentStatusFormatter` в Shared. Это позволит использовать красивые текстовые статусы и в списке торрентов, и в диагностике.

## 3. Дублирование кнопок в контекстных меню
**Локация:** `Remission/Views/TorrentList/TorrentListView.swift` (метод `contextMenu`)

**Проблема:**
Код для создания кнопок «Старт», «Пауза», «Удалить» в контекстном меню строки списка полностью повторяет логику кнопок действий в самой строке.

**Возможность рефакторинга:**
Использовать общее перечисление `TorrentActionType` для автоматической генерации как визуальных кнопок, так и пунктов контекстного меню.

## 4. Разрозненные Preview-фикстуры
**Локации:**
- `Remission/Domain/Torrent.swift` (расширения)
- `Remission/App/AppBootstrap.swift` (методы `torrentListSample*`)

**Проблема:**
Моковые данные для торрентов (загружающиеся, завершенные, с ошибками) описаны в разных местах. Это приводит к тому, что превью в SwiftUI и UI-тесты могут использовать данные разной степени актуальности.

**Возможность рефакторинга:**
Консолидировать все расширения для превью в одном месте — `Remission/Domain/Extensions/Torrent+Preview.swift`.

## 5. Остатки ServerConnectionErrorHelper
**Проблема:**
В проекте все еще может существовать `ServerConnectionErrorHelper`, чьи функции теперь полностью покрываются расширением `Error.userFacingMessage`.

**Возможность рефакторинга:**
Проверить использование и полностью удалить `ServerConnectionErrorHelper`, переведя остатки кода на новый стандарт обработки ошибок.
