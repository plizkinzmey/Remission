# План внедрения Remission

## Требования ко всем этапам
- **Context7 обязателен**: перед добавлением любой зависимости, конфигурацией инструмента или использованием новых версий обратитесь в Context7 для актуальной документации
- **Фреймворк тестирования**: Swift Testing (встроенный модуль) с атрибутом `@Test`, а не XCTest
- **Архитектура**: The Composable Architecture (TCA) для всего управления состоянием
- **Форматирование**: `swift-format format --in-place --recursive --configuration .swift-format`

## Веха 0: Подготовка окружения
- M0.1 Зафиксировать версии Xcode и Swift, обновив раздел "Системные требования" в README.
- M0.2 Добавить конфигурации swift-format и swiftlint, согласованные с правилами команды. Команды запуска: `swift-format format --in-place --recursive --configuration .swift-format <paths>` для применения и `swift-format format --recursive --configuration .swift-format <paths>` для проверки.
- M0.3 Подключить swift-format и swiftlint к локальному hook pre-commit.
- M0.4 Настроить общие параметры сборки для целей iOS и macOS в проекте Xcode.
- Проверка: выполнить `xcodebuild -scheme Remission -destination 'platform=iOS Simulator,name=iPhone 15' build` и убедиться, что линтеры завершаются без ошибок.

## Веха 1: Основа Transmission RPC
- M1.1 Смоделировать ключевые конечные точки Transmission RPC и структуры полезной нагрузки.
- M1.2 Реализовать кодирование и декодирование запросов и ответов с переводом ошибок в тип APIError.
- M1.3 Добавить механизм рукопожатия для получения session-id и согласования версий клиента и сервера.
- M1.4 Подготовить мок-сервер для модульных тестов сетевого слоя (использование Swift Testing с @Test).
- Проверка: покрыть тестами построение запросов и декодирование ответов на фиктивных данных с использованием Swift Testing фреймворка.

## Веха 2: Безопасность и аутентификация
- M2.1 Реализовать подстановку заголовка Basic Auth в TransmissionClient.
- M2.2 Сохранить учетные данные через обертку Keychain и написать для нее модульные тесты.
- M2.3 Предоставить безопасный API управления учетными данными для верхних слоев.
- M2.4 Задокументировать требования к HTTPS/TLS и проверке сертификатов.
- Проверка: модульные тесты Keychain и smoke-тест подключения к локальному Transmission с авторизацией.

## Веха 3: Доменное ядро
- M3.1 Описать доменные модели Torrent, ServerConfig и SessionState.
- M3.2 Настроить преобразование DTO Transmission RPC в доменные модели с валидацией полей.
- M3.3 Определить протоколы репозиториев для торрентов, сессий и настроек.
- M3.4 Подготовить заглушки репозиториев для тестов UI и TCA.
- Проверка: модульные тесты репозиториев с моками TransmissionClient.

## Веха 4: Инфраструктура TCA
- M4.1 Подготовить общие утилиты (абстракции времени, контейнер зависимостей, @Dependency макросы).
- M4.2 Определить типы AppState (@ObservableState), AppAction и приватные Reducers с @Reducer.
- M4.3 Описать в документации принципы композиции редьюсеров и обработки эффектов через .run { send in ... }.
- M4.4 Настроить TestStore и вспомогательные методы для тестирования редьюсеров с использованием Swift Testing.
- Проверка: модульные тесты базовых редьюсеров и резолвера зависимостей с использованием @Test.

## Веха 5: Онбординг и управление серверами
- M5.1 Создать TCA-фичу онбординга (@Reducer с @ObservableState State, Action).
- M5.2 Реализовать SwiftUI-экраны ввода host, port, протокола и учетных данных используя @Bindable для состояния.
- M5.3 Добавить проверку соединения и отображение статуса пользователю через асинхронные эффекты в редьюсере.
- M5.4 Сохранить конфигурации серверов и реализовать редактирование и удаление.
- Проверка: сквозной UI-тест онбординга и модульные тесты редьюсера с TestStore.

## Веха 6: Список торрентов
- M6.1 Описать TCA-состояние списка (@ObservableState: элементы, фильтры, сортировка, флаги загрузки) и действия.
- M6.2 Реализовать вызовы `torrent-get` с настраиваемым набором полей и обработкой ошибок через @Dependency.
- M6.3 Построить SwiftUI-список с индикаторами прогресса, скоростей и статуса.
- M6.4 Добавить поиск, элементы сортировки и жест pull-to-refresh, связав их с Actions.
- M6.5 Настроить периодический опрос через TimerTask или swift-clocks с конфигурируемым интервалом.
- Проверка: модульные тесты редьюсера с TestStore (успех, ошибка, отмена) и UI-тест отображения списка.

## Веха 7: Детали торрента
- M7.1 Создать TCA-состояние деталей (@ObservableState) с файлами, трекерами, пирами и историей скоростей.
- M7.2 Получать детальные данные через @Dependency repository и отображать их в SwiftUI View.
- M7.3 Реализовать Actions и Effects для команд: "Запуск", "Пауза", "Удаление", "Проверка", "Изменение приоритета".
- M7.4 Спроектировать SwiftUI-представление разделов с учетом доступности и VoiceOver (accessibilityIdentifier, accessibilityLabel).
- Проверка: модульные тесты редьюсера команд с TestStore и UI-тест перехода из списка в детали.

## Веха 8: Добавление торрента
- M8.1 Реализовать обработчики импорта `.torrent` (FileImporter) и magnet-ссылок (Pasteboard/Share) в TCA действиях.
- M8.2 Добавить TCA-фичу диалога добавления торрента (@Reducer, @ObservableState) с параметрами (путь, старт в паузе, теги).
- M8.3 Интегрировать вызов `torrent-add` через @Dependency repository и обработку ответа Transmission в Effects.
- M8.4 Обновить состояние списка торрентов после успешного добавления через композицию редьюсеров.
- Проверка: модульные тесты редьюсера с TestStore и интеграционный тест с локальным Transmission.

## Веха 9: Настройки и предпочтения
- M9.1 Реализовать TCA-состояние настроек (@ObservableState) для интервала опроса, автообновления и лимитов по умолчанию.
- M9.2 Сохранить предпочтения в UserDefaults или выделенном хранилище через @Dependency.
- M9.3 Создать SwiftUI-контролы с группировкой настроек и описаниями, используя @Bindable.
- M9.4 Обновить редьюсеры зависимых фич для чтения выбранных настроек через @Dependency.
- Проверка: модульные тесты сохранения и чтения настроек с TestStore и UI-тест изменения значений с проверкой персистентности.

## Веха 10: Логирование и телеметрия
- M10.1 Интегрировать `swift-log` с согласованными уровнями логирования (debug, info, warning, error).
- M10.2 Сохранять сетевые и RPC-ошибки с контекстной метаинформацией через @Dependency Logger.
- M10.3 Добавить опциональный переключатель отправки телеметрии (по умолчанию отключен) в настройках.
- M10.4 Подготовить гайд по чтению логов и диагностике для пользователей.
- Проверка: модульные тесты форматирования логов с использованием @Test и ручная проверка поведения переключателя.

## Веха 11: Локализация и доступность
- M11.1 Вынести пользовательские строки через Localizable.strings и добавить базовую локализацию на русском языке.
- M11.2 Подготовить англоязычную локализацию (en) и проверить плейсхолдеры.
- M11.3 Провести аудит экранов на VoiceOver (accessibilityIdentifier, accessibilityLabel, accessibilityHint), Dynamic Type и контрастность.
- M11.4 Настроить автоматические проверки отсутствующих строк в сборке через скрипты.
- Проверка: предпросмотр локализаций в Xcode, UI-тест в EN-локали и аудит с VoiceOver.

## Веха 12: Устойчивость к офлайн-режиму и ошибкам
- M12.1 Реализовать поведение при потере сети в TCA Effects: кеш состояния и экспоненциальный повтор запросов.
- M12.2 Отображать понятные баннеры ошибок и дать возможность повторить действие через SwiftUI AlertState (TCA).
- M12.3 Добавить экран диагностики для последних ошибок и логов через TCA-фичу.
- M12.4 Согласовать политику хранения и очистки кеша в @Dependency services.
- Проверка: модульные тесты офлайн-сценариев с TestStore и UI-тест отображения баннеров.

## Веха 13: Интеграционные испытания Transmission
- M13.1 Подготовить docker-compose сценарий для локального запуска Transmission с известной конфигурацией.
- M13.2 Добавить интеграционные тесты (Swift Testing @Test) для сценариев: подключение, добавление, запуск, пауза, удаление торрентов.
- M13.3 Автоматизировать поднятие и остановку Transmission через скрипт разработчика (bin/setup-docker.sh).
- M13.4 Сохранять логи и артефакты интеграционных тестов для анализа в CI.
- Проверка: успешный локальный прогон интеграционного сценария с сохраненными артефактами.

## Веха 14: Готовность к релизу
- M14.1 Обновить документацию (README, CONTRIBUTING, AGENTS, PRD) с актуальными процессами, требованиями Context7 и ссылками.
- M14.2 Сформировать заметки о релизе с фиксацией выполненных требований PRD и версионированием.
- M14.3 Провести исследовательское тестирование билдов macOS и iOS с актуальными инструментами (swift-format, swiftlint).
- M14.4 Составить чек-лист для публикации в App Store/TestFlight (сертификаты, профили, метаданные, локализация).
- Проверка: подтверждения от разработчиков, QA и PM, а также успешная сборка архивов для публикации с прогоном всех тестов.
