# План внедрения Remission

## Требования ко всем этапам
- **Context7 критический чек-лист**: перед добавлением любой зависимости, конфигурацией инструмента или использованием новых версий обратитесь в Context7 для актуальной документации. Используйте `mcp_context7_resolve-library-id` и `mcp_context7_get-library-docs` для получения последней информации.
- **Фреймворк тестирования**: Swift Testing (встроенный модуль) с атрибутом `@Test`, а не XCTest. Минимум покрытия: happy path + error path для каждого редьюсера.
- **Архитектура**: The Composable Architecture (TCA) для всего управления состоянием. @ObservableState, enum Action, @Reducer. Не смешивать TCA и MVVM.
- **Форматирование и стиль**: 
  - `swift-format format --in-place --recursive --configuration .swift-format` для форматирования
  - `swift-format lint --configuration .swift-format --recursive --strict` для проверки
  - `swiftlint lint` для стиля кода (встроено в Xcode build phase)
- **Безопасность**: все credentials хранятся в Keychain, никогда не логируются пароли, HTTPS обязателен с проверкой сертификатов

## Веха 0: Подготовка окружения
- M0.1 Зафиксировать версии Xcode 15.0+ и Swift 6.0+, обновив раздел "Системные требования" в README и Environment & Requirements в документации.
- M0.2 Добавить конфигурации swift-format и swiftlint, согласованные с правилами команды. Команды:
  - Форматирование: `swift-format format --in-place --recursive --configuration .swift-format Remission RemissionTests RemissionUITests`
  - Проверка (lint): `swift-format lint --configuration .swift-format --recursive --strict Remission RemissionTests RemissionUITests`
  - SwiftLint: `swiftlint lint` (автоматически запускается в build phase)
- M0.3 Подключить swift-format и swiftlint к локальному hook pre-commit через `bash Scripts/prepare-hooks.sh`. Проверить, что hook работает с `git commit --allow-empty -m "Test"`.
- M0.4 Унифицировать build settings для всех целей (iOS, macOS, visionOS): Swift 6.0, Deployment Target 26.0, SUPPORTED_PLATFORMS, App Sandbox, Hardened Runtime.
- M0.5 Обновить AGENTS.md с разделом "Build Settings & Unified Configuration" и таблицей ключевых параметров.
- Проверка: выполнить `xcodebuild -scheme Remission -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 12' build` и `xcodebuild -scheme Remission -sdk macosx build`. Оба должны завершиться с BUILD SUCCEEDED без новых предупреждений.

## Веха 1: Основа Transmission RPC
- M1.1 Смоделировать ключевые конечные точки Transmission RPC и структуры полезной нагрузки.
- M1.2 Реализовать кодирование и декодирование запросов и ответов с переводом ошибок в тип APIError.
- M1.3 Добавить механизм рукопожатия для получения session-id и согласования версий клиента и сервера.
- M1.4 Подготовить мок-сервер для модульных тестов сетевого слоя (использование Swift Testing с @Test).
- Проверка: покрыть тестами построение запросов и декодирование ответов на фиктивных данных с использованием Swift Testing фреймворка.

## Веха 2: Безопасность и аутентификация
- M2.1 Реализовать подстановку заголовка Basic Auth в TransmissionClient согласно HTTPS требованиям.
- M2.2 Сохранить учетные данные через обертку Keychain (используя `kSecAttrAccountClass` для категоризации) и написать для нее модульные тесты Swift Testing.
- M2.3 Предоставить безопасный API управления учетными данными для верхних слоев. НИКОГДА не логировать пароли — логировать только "Auth successful" или error codes.
- M2.4 Задокументировать требования к HTTPS/TLS, проверке сертификатов и обработке self-signed сертификатов (показать диалог пользователю).
- M2.5 Добавить требование HTTPS при подключении с предупреждением для HTTP соединений в Keychain раздел PRD.
- Проверка: модульные тесты Keychain с использованием Swift Testing (@Test) и smoke-тест подключения к локальному Transmission с авторизацией.

## Веха 3: Доменное ядро
- M3.1 Описать доменные модели Torrent, ServerConfig и SessionState.
- M3.2 Настроить преобразование DTO Transmission RPC в доменные модели с валидацией полей.
- M3.3 Определить протоколы репозиториев для торрентов, сессий и настроек.
- M3.4 Подготовить заглушки репозиториев для тестов UI и TCA.
- Проверка: модульные тесты репозиториев с моками TransmissionClient.

## Веха 4: Инфраструктура TCA
- M4.1 Подготовить общие утилиты (абстракции времени через swift-clocks, контейнер зависимостей через @Dependency, Environment setup).
- M4.2 Определить типы AppState (@ObservableState), AppAction и приватные Reducers с @Reducer. Документировать версионирование State структур для миграций.
- M4.3 Описать в документации принципы композиции редьюсеров и обработки эффектов через `.run { send in ... }` блоки. Все побочные эффекты должны быть инкапсулированы через Environment.
- M4.4 Настроить TestStore и вспомогательные методы для тестирования редьюсеров с использованием Swift Testing (@Test). Каждый редьюсер должен иметь хотя бы happy path и error path тесты.
- M4.5 Добавить примеры использования @Dependency для мокирования services и repositories в тестах.
- Проверка: модульные тесты базовых редьюсеров с использованием Swift Testing @Test и TestStore с mock зависимостями.

## Веха 5: Онбординг и управление серверами
- M5.1 Создать TCA-фичу онбординга (@Reducer с @ObservableState State, Action).
- M5.2 Реализовать SwiftUI-экраны ввода host, port, протокола и учетных данных используя @Bindable для состояния.
- M5.3 Добавить проверку соединения и отображение статуса пользователю через асинхронные эффекты в редьюсере.
- M5.4 Сохранить конфигурации серверов и реализовать редактирование и удаление.
- Проверка: сквозной UI-тест онбординга и модульные тесты редьюсера с TestStore.

## Веха 6: Список торрентов
- M6.1 Описать TCA-состояние списка (@ObservableState: элементы как IdentifiedArray, фильтры, сортировка, флаги загрузки) и действия через enum Action.
- M6.2 Реализовать вызовы `torrent-get` с настраиваемым набором полей через @Dependency repository. Обработка ошибок и exponential backoff через Effects.
- M6.3 Построить SwiftUI-список с индикаторами прогресса, скоростей и статуса. Использовать @Bindable для state.
- M6.4 Добавить поиск, элементы сортировки и жест pull-to-refresh, связав их с Actions в reducer.
- M6.5 Настроить периодический опрос через Task и swift-clocks для детерминированного тестирования с конфигурируемым интервалом.
- M6.6 Покрыть редьюсер тестами Swift Testing: happy path, error scenarios, retry logic с использованием TestStore.
- Проверка: модульные тесты редьюсера с TestStore (успех, ошибка, отмена) и UI-тест отображения списка на симуляторе iPhone 12.

## Веха 7: Детали торрента
- M7.1 Создать TCA-состояние деталей (@ObservableState) с файлами, трекерами, пирами и историей скоростей. Использовать Identifiable для коллекций.
- M7.2 Получать детальные данные через @Dependency repository и отображать их в SwiftUI View с @Bindable для состояния.
- M7.3 Реализовать Actions и Effects для команд: "Запуск", "Пауза", "Удаление", "Проверка", "Изменение приоритета". Каждый Effect должен вызывать repository через @Dependency.
- M7.4 Спроектировать SwiftUI-представление разделов с учетом доступности и VoiceOver (accessibilityIdentifier, accessibilityLabel, accessibilityHint для каждого элемента).
- M7.5 Добавить обработку edge cases (нулевые значения, отсутствующие файлы) согласно PRD.
- Проверка: модульные тесты редьюсера команд с TestStore (happy path + error scenarios) и UI-тест перехода из списка в детали на симуляторе iPhone 12.

## Веха 8: Добавление торрента
- M8.1 Реализовать обработчики импорта `.torrent` (FileImporter) и magnet-ссылок (Pasteboard/Share) в TCA действиях.
- M8.2 Добавить TCA-фичу диалога добавления торрента (@Reducer, @ObservableState) с параметрами (путь, старт в паузе, теги).
- M8.3 Интегрировать вызов `torrent-add` через @Dependency repository и обработку ответа Transmission в Effects.
- M8.4 Обновить состояние списка торрентов после успешного добавления через композицию редьюсеров.
- Проверка: модульные тесты редьюсера с TestStore и интеграционный тест с локальным Transmission.

## Веха 9: Настройки и предпочтения
- M9.1 Реализовать TCA-состояние настроек (@ObservableState) для интервала опроса, автообновления и лимитов по умолчанию.
- M9.2 Сохранить предпочтения в UserDefaults или выделенном хранилище через @Dependency.
- M9.3 Создать SwiftUI-контролы с группировкой настроек и описаниями, используя @Bindable.
- M9.4 Обновить редьюсеры зависимых фич для чтения выбранных настроек через @Dependency.
- Проверка: модульные тесты сохранения и чтения настроек с TestStore и UI-тест изменения значений с проверкой персистентности.

## Веха 10: Логирование и телеметрия
- M10.1 Интегрировать `swift-log` (Swift.org official) с согласованными уровнями логирования (debug, info, warning, error) через @Dependency Logger.
- M10.2 Сохранять сетевые и RPC-ошибки с контекстной метаинформацией. **КРИТИЧЕСКИ**: никогда не логировать пароли, usernames, токены или sensitive данные.
- M10.3 Добавить опциональный переключатель отправки телеметрии (по умолчанию отключен) в настройках с явным согласием пользователя.
- M10.4 Подготовить гайд по чтению логов и диагностике для пользователей в документации.
- M10.5 Добавить экран диагностики в UI для просмотра последних логов (для разработчиков и support).
- Проверка: модульные тесты форматирования логов с использованием Swift Testing @Test и ручная проверка поведения переключателя. Убедиться, что credentials никогда не логируются.

## Веха 11: Локализация и доступность
- M11.1 Вынести пользовательские строки через Localizable.strings и добавить базовую локализацию на русском языке.
- M11.2 Подготовить англоязычную локализацию (en) и проверить плейсхолдеры.
- M11.3 Провести аудит экранов на VoiceOver (accessibilityIdentifier, accessibilityLabel, accessibilityHint), Dynamic Type и контрастность.
- M11.4 Настроить автоматические проверки отсутствующих строк в сборке через скрипты.
- Проверка: предпросмотр локализаций в Xcode, UI-тест в EN-локали и аудит с VoiceOver.

## Веха 12: Устойчивость к офлайн-режиму и ошибкам
- M12.1 Реализовать поведение при потере сети в TCA Effects: кеш состояния и экспоненциальный повтор запросов.
- M12.2 Отображать понятные баннеры ошибок и дать возможность повторить действие через SwiftUI AlertState (TCA).
- M12.3 Добавить экран диагностики для последних ошибок и логов через TCA-фичу.
- M12.4 Согласовать политику хранения и очистки кеша в @Dependency services.
- Проверка: модульные тесты офлайн-сценариев с TestStore и UI-тест отображения баннеров.

## Веха 13: Интеграционные испытания Transmission
- M13.1 Подготовить docker-compose сценарий для локального запуска Transmission 3.0+ с известной конфигурацией (rpc-port, auth).
- M13.2 Добавить интеграционные тесты (Swift Testing @Test) для критических сценариев: подключение, добавление torrent, запуск, пауза, удаление. Проверка совместимости с RPC версией через `session-get`.
- M13.3 Автоматизировать поднятие и остановку Transmission через скрипт разработчика (bin/setup-docker.sh или аналогичный).
- M13.4 Обеспечить обработку edge cases: timeout, rate-limiting (429), несовместимые версии API, пустые ответы согласно PRD.
- M13.5 Сохранять логи и артефакты интеграционных тестов для анализа в CI.
- Проверка: успешный локальный прогон интеграционного сценария с сохраненными артефактами. Все критические пути должны пройти без ошибок.

## Веха 14: Готовность к релизу
- M14.1 Обновить документацию (README, CONTRIBUTING, AGENTS, PRD, plan.md) с актуальными процессами, требованиями Context7, ссылками на инструменты и примерами из актуальной версии.
- M14.2 Сформировать CHANGELOG с фиксацией выполненных требований PRD, версионированием и описанием миграций State структур.
- M14.3 Провести исследовательское тестирование билдов macOS и iOS с актуальными инструментами (swift-format, swiftlint, Xcode 15.0+, Swift 6.0).
- M14.4 Составить чек-лист для публикации (сертификаты, профили, метаданные App Store, локализация RU/EN, иконки, скриншоты).
- M14.5 Убедиться, что покрытие тестами >= 60% на ключевых компонентах (используя xcov или Xcode Code Coverage).
- M14.6 Запустить финальный набор тестов: unit (Swift Testing), integration (Transmission docker), UI (XCUITest) на iOS Simulator и macOS.
- Проверка: подтверждения от разработчиков, QA и PM. Успешная сборка архивов для публикации с прогоном всех тестов без ошибок и новых предупреждений.
