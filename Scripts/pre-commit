#!/bin/bash
# Git pre-commit hook for swift-format and swiftlint
# This hook runs swift-format and swiftlint checks before allowing a commit
# 
# Installation: Run Scripts/prepare-hooks.sh
# Skip (if needed): git commit --no-verify

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the project root directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Handle Apple Silicon PATH if needed
if [[ "$(uname -m)" == arm64 ]]; then
    export PATH="/opt/homebrew/bin:$PATH"
fi

echo -e "${BLUE}ğŸ” Running pre-commit checks...${NC}"
echo ""

# Track if any checks failed
CHECKS_FAILED=0

# ============================================================================
# 1. swift-format lint check (Apple's swift-format: diagnose style issues)
# ============================================================================
echo -e "${BLUE}1ï¸âƒ£  Checking code formatting with swift-format lint...${NC}"

if command -v swift-format &> /dev/null; then
    # swift-format lint: use --strict to treat all findings as errors
    if swift-format lint --configuration .swift-format --recursive --strict Remission RemissionTests RemissionUITests; then
        echo -e "${GREEN}   âœ… swift-format lint check passed${NC}"
    else
        echo -e "${RED}   âŒ swift-format lint check failed${NC}"
        echo ""
        echo -e "${YELLOW}   ğŸ’¡ To auto-fix formatting issues, run:${NC}"
        echo -e "   ${BLUE}swift-format format --in-place --configuration .swift-format --recursive Remission RemissionTests RemissionUITests${NC}"
        echo ""
        CHECKS_FAILED=1
    fi
else
    echo -e "${RED}   âŒ swift-format not found${NC}"
    echo -e "   ${RED}   Install: brew install swift-format${NC}"
    CHECKS_FAILED=1
fi

echo ""

# ============================================================================
# 2. SwiftLint check
# ============================================================================
echo -e "${BLUE}2ï¸âƒ£  Checking code style with SwiftLint...${NC}"

if command -v swiftlint &> /dev/null; then
    if swiftlint lint --reporter xcode; then
        echo -e "${GREEN}   âœ… SwiftLint check passed${NC}"
    else
        echo -e "${RED}   âŒ SwiftLint check failed${NC}"
        echo ""
        echo -e "${YELLOW}   ğŸ’¡ To auto-fix some violations, run:${NC}"
        echo -e "   ${BLUE}swiftlint --fix${NC}"
        echo ""
        CHECKS_FAILED=1
    fi
else
    echo -e "${YELLOW}   âš ï¸  SwiftLint not found (skipping check)${NC}"
    echo -e "   ${YELLOW}   Install: brew install swiftlint${NC}"
fi

echo ""

# ============================================================================
# 3. Final result
# ============================================================================
if [ $CHECKS_FAILED -eq 0 ]; then
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ¨ All pre-commit checks passed! âœ¨${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 0
else
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ Pre-commit checks failed${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above and try committing again, or:${NC}"
    echo -e "${YELLOW}Skip the hook (use with caution):${NC}"
    echo -e "   ${BLUE}git commit --no-verify${NC}"
    echo ""
    exit 1
fi
