# Руководство по выпуску релизов (Release Guide)

Этот документ описывает процесс подготовки и публикации новых версий приложения Remission с использованием автоматизированного скрипта `Scripts/release_local.sh`.

## Содержание
1. [Обзор скрипта](#обзор-скрипта)
2. [Предварительные требования](#предварительные-требования)
3. [Основные параметры](#основные-параметры)
4. [Примеры использования](#примеры-использования)
5. [Интеграция с GitHub](#интеграция-с-github)
6. [Рабочий процесс (Workflow)](#рабочий-процесс-workflow)
7. [Устранение неполадок](#устранение-неполадок)

---

## Обзор скрипта
Скрипт `Scripts/release_local.sh` автоматизирует следующие задачи:
*   Обновление версии в проекте Xcode (`MARKETING_VERSION`).
*   Сборка архивов (`.xcarchive`) для iOS и macOS.
*   Экспорт `.ipa` для iOS (требуется `ExportOptions.plist`).
*   Создание `.zip` архива для macOS.
*   Создание Git-тега.
*   Публикация изменений и тегов в удаленный репозиторий.
*   Создание релиза на GitHub с автоматическим списком изменений и загрузкой артефактов.
*   Синхронизация версии с веткой `develop`.

## Предварительные требования
Для корректной работы скрипта необходимо:
1.  **Xcode 16+**: Инструменты командной строки должны быть установлены.
2.  **GitHub CLI (`gh`)**: Установлен и авторизован (`gh auth login`). Рекомендуется выбирать аутентификацию через браузер и SSH для работы с репозиторием. Минимально необходимые права (scopes): `repo`, `read:org`.

3.  **Python 3**: Используется для обработки файла проекта.
4.  **Чистая рабочая директория**: Скрипт требует отсутствия незакоммиченных изменений (можно обойти через `--allow-dirty`).
5.  **Ветка `main`**: Релизы разрешены только из ветки `main`.

## Основные параметры

### Управление версией (обязательно одно из)
*   `--version X.Y.Z`: Установить конкретную версию.
*   `--bump {major|minor|patch}`: Автоматически увеличить версию (на основе последнего тега).

### Действия Git
*   `--tag`: Создать аннотированный Git-тег для новой версии.
*   `--push`: Отправить (push) коммиты и теги в удаленный репозиторий.
*   `--no-version-commit`: Обновить версию в файлах, но не создавать коммит.

### Сборка
*   `--platform {all|ios|macos}`: Выбрать платформу для сборки (по умолчанию `all`).
*   `--export-options-plist PATH`: Путь к файлу конфигурации экспорта iOS (по умолчанию `ExportOptions.plist`).
*   `--version-only`: Только обновить версию без запуска сборки.

### GitHub Release
*   `--github-release`: Создать релиз на GitHub.
*   `--pre-release`: Пометить релиз как предварительный (Pre-release).
*   `--draft`: Создать релиз как черновик (Draft). Требует ручного подтверждения публикации в веб-интерфейсе GitHub. При использовании на macOS автоматически открывает ссылку на черновик в браузере.
*   `--skip-build`: Пропустить этап сборки. Полезно, если архивы уже созданы (например, при повторном запуске после ошибки авторизации GitHub).
*   `--notes-file PATH`: Использовать свой Markdown-файл для текста релиза на GitHub. Рекомендуется для человекочитаемого описания и двуязычных (RU/EN) заметок.

## Примеры использования

### 1. Создание обычного патч-релиза (Локально)
Просто обновит версию и соберет файлы в `Build/Releases/`:
```bash
./Scripts/release_local.sh --bump patch
```

### 2. Полный цикл публикации (Draft на GitHub)
Обновит версию, создаст тег, запушит в `main`, создаст черновик релиза на GitHub и загрузит туда `.ipa` и `.zip`:
```bash
./Scripts/release_local.sh --bump minor --tag --push --github-release --draft
```

### 3. Публикация предрелиза (Beta)
```bash
./Scripts/release_local.sh --version 1.2.0 --tag --push --github-release --pre-release
```

## Интеграция с GitHub
При использовании флага `--github-release`, скрипт:
1.  Проверяет авторизацию через `gh auth status`.
2.  По умолчанию генерирует `Build/Releases/vX.Y.Z/release_notes.md`: шаблон RU/EN + список коммитов от предыдущего тега до текущего (для проверки перед публикацией).
3.  Находит скомпилированные артефакты в папке `Build/Releases/vX.Y.Z/`.
4.  Создает релиз через API GitHub.

Если вы хотите контролировать текст релиза (например, писать "Что нового" на русском и английском), подготовьте файл и передайте его через `--notes-file`:
```bash
./Scripts/release_local.sh --version X.Y.Z --tag --push --github-release --draft --notes-file Doc/ReleaseNotes/vX.Y.Z.md
```

Если указан флаг `--draft`, релиз не будет виден пользователям. Вы сможете зайти в раздел **Releases** вашего репозитория, проверить описание, список файлов и нажать кнопку **"Publish"**.

## Рабочий процесс (Workflow)
Рекомендуемый порядок действий:
1.  Убедитесь, что вы находитесь в ветке `main` и она синхронизирована с сервером.
2.  Запустите скрипт с нужными флагами (рекомендуется использовать `--draft` для первого контроля).
3.  После завершения скрипта, проверьте артефакты в папке `Build/Releases/`.
4.  Зайдите на GitHub, проверьте созданный черновик релиза.
5.  Если всё верно, опубликуйте релиз.
6.  Скрипт автоматически синхронизирует ветку `develop` с `main`, чтобы версии совпадали.

## Устранение неполадок
*   **Ошибка авторизации GitHub**: Если скрипт сообщил об ошибке авторизации, выполните `gh auth login`. После этого вы можете завершить релиз без повторной сборки (которая занимает много времени), используя флаг `--skip-build`:
    ```bash
    ./Scripts/release_local.sh --version X.Y.Z --github-release --draft --skip-build --allow-dirty
    ```
*   **Ошибка подписи iOS**: Убедитесь, что в `ExportOptions.plist` указан правильный метод распределения (app-store, ad-hoc, и т.д.) и ваши сертификаты актуальны.
*   **Скрипт не видит изменения**: Если вы изменили `project.pbxproj` вручную, закоммитьте изменения перед запуском скрипта.
*   **GitHub CLI (gh) не найден**: Установите его через `brew install gh` (для macOS).

---
*Документация актуальна для версии скрипта от 31.01.2026.*
